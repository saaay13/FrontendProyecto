@page
@model AdminReconocimientosIndexModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Administrador")]
@{
    ViewData["Title"] = "Reconocimientos";
}

<h2 class="mb-3">Reconocimientos</h2>

<div class="d-flex gap-2 mb-3">
    <a asp-page="./CreateC" class="btn btn-outline-primary">Nuevo carnet</a>
</div>

<!-- ===================== CERTIFICADOS ===================== -->
<h4 class="mt-4 mb-2">Certificados</h4>
<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Id</th>
                <th>Código</th>
                <th>Voluntario</th>
                <th>ONG</th>
                <th>Proyecto</th>
                <th>Actividad</th>
                <th>Emisión</th>
                <th class="text-end" style="width:180px;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Certificados is null || !Model.Certificados.Any())
            {
                <tr>
                    <td colspan="8" class="text-center py-3">No hay certificados</td>
                </tr>
            }
            else
            {
                @foreach (var c in Model.Certificados)
                {
                    <tr>
                        <td>@c.IdCertificado</td>
                        <td class="small text-muted">@c.CodigoVerificacion</td>
                        <td class="fw-semibold">@c.UsuarioNombre</td>
                        <td>@c.OngNombre</td>
                        <td>@c.ProyectoNombre</td>
                        <td>@c.ActividadNombre</td>
                        <td class="text-nowrap">@c.FechaEmision.ToString("dd/MM/yyyy")</td>
                        <td class="text-end text-nowrap">
                            
                            <form method="post"
                                  asp-page-handler="AnularCert"
                                  asp-route-id="@c.IdCertificado"
                                  class="d-inline"
                                  onsubmit="return confirm('¿Anular certificado?');">
                                @Html.AntiForgeryToken()
                                <button class="btn btn-sm btn-danger">Anular</button>
                            </form>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<!-- ===================== CARNETS ===================== -->
<h4 class="mt-5 mb-2">Carnets</h4>
<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Id</th>
                <th>Nro/Código</th>
                <th>Voluntario</th>
                <th>ONG</th>
                <th>Emisión</th>
                <th>Vencimiento</th>
                <th>Estado</th>
                <th class="text-end" style="width:180px;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Carnets is null || !Model.Carnets.Any())
            {
                <tr>
                    <td colspan="8" class="text-center py-3">No hay carnets</td>
                </tr>
            }
            else
            {
                @foreach (var k in Model.Carnets)
                {
                    var vencido = k.FechaVencimiento.HasValue && k.FechaVencimiento.Value.Date < DateTime.Today;
                    var (badgeClass, badgeText) = !k.Activo
                    ? ("badge bg-secondary", "Inactivo")
                    : (vencido ? ("badge bg-danger", "Vencido") : ("badge bg-success", "Activo"));

                    <tr>
                        <td>@k.IdCarnet</td>
                        <td class="small text-muted">
                            @k.CodigoVerificacion
                            @* Si fuera Guid y quieres sin guiones: @(Guid.TryParse(k.CodigoVerificacion, out var g) ? g.ToString("N") : k.CodigoVerificacion) *@
                        </td>
                        <td class="fw-semibold">@k.UsuarioNombre</td>
                        <td>@k.OngNombre</td>
                        <td class="text-nowrap">@k.FechaEmision.ToString("dd/MM/yyyy")</td>
                        <td class="text-nowrap">@((k.FechaVencimiento?.ToString("dd/MM/yyyy")) ?? "-")</td>
                        <td><span class="@badgeClass">@badgeText</span></td>
                        <td class="text-end text-nowrap">
                            <a class="btn btn-sm btn-outline-primary" asp-page="./Pdf" asp-route-id="@k.IdCarnet" target="_blank">
                                Descargar
                            </a>

                            <form method="post"
                                  asp-page-handler="AnularCarnet"
                                  asp-route-id="@k.IdCarnet"
                                  class="d-inline"
                                  onsubmit="return confirm('¿Eliminar carnet?');">
                                @Html.AntiForgeryToken()
                                <button class="btn btn-sm btn-danger">Eliminar</button>
                            </form>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>


<!-- (Opcional) Sección de emisión simple como nota -->
<div class="mt-5 text-muted">
    ¿Necesitas emitir un certificado o carnet? Usa los botones de arriba.
</div>
